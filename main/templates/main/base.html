<!DOCTYPE html>
<html lang="ru">
<div id="page-container">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}–°–æ–ª—è—Ä–∏–π{% endblock %}</title>
        {% load static %}
        <!-- –ù–∞—à–∏ Css –¥–ª—è –º–æ–¥–µ–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ –≤—Å–µ–≥–æ —Å—Ç–∏–ª—è -->
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
        <link rel="stylesheet" href="{% static 'css/modal.css' %}">

        <!-- jQuery (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Bootstrap –∑–∞–≤–∏—Å—è—Ç –æ—Ç —ç—Ç–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        
        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Swiper CSS -->
        <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Font Awesome -->
                   
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
                
        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bootstrap CSS –∏ JS —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                          
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        
        
        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet CSS –±–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ integrity –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
        
        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Swiper JS -->
        <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

        <!-- Css –¥–ª—è —à–∞–ø–∫–∏ –∏ –ø–æ–¥–≤–∞–ª–∞ -->
        <link rel="stylesheet" href="{% static 'css/header_footer.css' %}">
        <link rel="stylesheet" href="{% static 'css/cart.css' %}">
       
    </head>
    
<body>

{% include 'main/header.html' %}



<main>
    <!-- <div class="container mt-5"> -->
    {% block content %}
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–¥–µ—Å—å -->
    {% endblock %}
    <!-- </div> -->

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
    <button id="calendarButton" onclick="openCalendarModal()">üìÖ –ó–∞–ø–∏—Å—å</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
    <div id="calendarModal" class="booking-modal" style="display:none;">
        <div class="booking-modal-content">
            <span class="booking-close-button" onclick="closeModal('calendarModal')">√ó</span>
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</h2>
            <input type="date" id="bookingDate">
            <input type="time" id="bookingTime">
            <button onclick="submitBooking()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>
</main>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Ö–æ–¥–∞ -->
<div id="loginModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-button" onclick="closeModal('loginModal')">√ó</span>
        <h2>–í—Ö–æ–¥</h2>
        <form id="loginForm" data-login-url="{% url 'login' %}">
            {% csrf_token %}
            <input type="text" placeholder="–õ–æ–≥–∏–Ω –∏–ª–∏ email" name="username" required>
            <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" name="password" required>
            <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
            <div id="loginError" class="alert alert-danger d-none"></div> 
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="signupModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-button" onclick="closeModal('signupModal')">√ó</span>
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <form id="signupForm" method="post" action="{% url 'signup' %}"> 
            {% csrf_token %}
            <input type="text" placeholder="–õ–æ–≥–∏–Ω" name="username" required>
            <input type="email" placeholder="Email" name="email" required>
            <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" name="password1" id="password" required pattern=".{8,}" title="–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤"> 
            <input type="password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" name="password2" id="confirm_password" required oninput="check(this)">
            <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="signupError" class="alert alert-danger d-none"></div> 
        </form>
    </div>
</div> 

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
<div class="modal fade" id="checkoutModal" tabindex="-1" role="dialog" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="checkoutModalLabel">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'process_checkout' %}">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
            </div>
        </div>
    </div>
</div>


{% include 'main/footer.html' %}

</div>

{% block script %}

{% endblock %}

<script>
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        var existingBackground = document.querySelector('.blur-background');
        if (!existingBackground) {
            var blurBackground = document.createElement('div');
            blurBackground.classList.add('blur-background');
            document.body.appendChild(blurBackground);
        }

        modal.style.display = "block";
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        var blurBackground = document.querySelector('.blur-background');
        if (blurBackground) blurBackground.remove();
        
        modal.style.display = "none";
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.onclick = function(event) {
        if (event.target.classList.contains('custom-modal')) {
            event.target.style.display = "none";
        }
    }
    function check(input) {
        if (input.value != document.getElementById('password').value) {
            input.setCustomValidity('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.');
        } else {
            input.setCustomValidity('');
        }
    }
</script>
<script>
    window.onload = function() {
        if (document.querySelector(".messages .alert")) {
            openModal('loginModal');
        }
    };
    window.onclick = function(event) {
    if (event.target.classList.contains('blur-background')) {
        closeModal('loginModal'); 

    }
}
</script>
<script>
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
    document.addEventListener('DOMContentLoaded', function() {
        var loginForm = document.getElementById('loginForm');
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var errorDiv = document.getElementById('loginError');
            var formData = new FormData(this);

            fetch(loginForm.dataset.loginUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('loginModal'); 
                    location.reload(); 
                } else {
                    errorDiv.textContent = data.error; 
                    errorDiv.classList.add('alert-error'); 
                    errorDiv.classList.remove('d-none'); 
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞:', error);
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        var signupForm = document.getElementById('signupForm');
        signupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            var errorDiv = document.getElementById('signupError'); 

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('signupModal'); 
                    location.reload(); 
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.add('alert-error'); 
                    errorDiv.classList.remove('d-none'); 
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                errorDiv.classList.remove('d-none');
            });
        });
    });
 
</script>
<script>
    function openCalendarModal() {
        var modal = document.getElementById('calendarModal');
        var existingBackground = document.querySelector('.blur-background');
        if (!existingBackground) {
            var blurBackground = document.createElement('div');
            blurBackground.classList.add('blur-background');
            document.body.appendChild(blurBackground);
        }
        modal.style.display = 'block';
    }

    function submitBooking() {
        var date = document.getElementById('bookingDate').value;
        var time = document.getElementById('bookingTime').value;
        console.log('Booking for: ' + date + ' at ' + time); // –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

        fetch('/api/book_appointment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            },
            body: JSON.stringify({
                date: date,
                time: time
            })
        })
        .then(response => {
            if (response.ok) {
                console.log('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                closeModal('calendarModal'); // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                // –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            } else {
                return response.json().then(data => { throw new Error(data.error) });
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
        });
        }




window.onscroll = function() {
    var button = document.getElementById("calendarButton");
    var footerHeight = document.querySelector("footer").offsetHeight; 
    var windowHeight = window.innerHeight;
    var scrollPosition = window.pageYOffset;
    var buttonHeight = button.offsetHeight;
    var fromBottom = 20; 

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –æ—Ç –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –æ–∫–Ω–∞ –¥–æ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —Ñ—É—Ç–µ—Ä–∞
    var footerTop = document.body.scrollHeight - footerHeight - scrollPosition;
    if (footerTop < windowHeight) {
        button.style.bottom = (windowHeight - footerTop + fromBottom) + "px";
    } else {
        button.style.bottom = fromBottom + "px";
    }
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.onresize = function() {
    window.onscroll();
};

// –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
window.onload = function() {
    window.onscroll();
};

</script>
</body>
</html>
