<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}Солярий{% endblock %}</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
        <link rel="stylesheet" href="{% static 'css/modal.css' %}">
        <!-- Подключение Swiper CSS -->
        <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
        <!-- Подключение Font Awesome -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
        <!-- Подключение Bootstrap CSS с официального CDN -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
        <!-- Подключение Leaflet CSS без атрибута integrity для устранения ошибок загрузки -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
        <!-- Подключение Swiper JS -->
        <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
        <!-- jQuery (Bootstrap зависит от этой библиотеки) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    </head>
    
<body>

{% include 'main/header.html' %}



<main>
    {% block content %}
    <!-- Содержимое будет переопределено в дочерних шаблонах -->
    {% endblock %}
</main>

<!-- Модальное окно для входа -->
<div id="loginModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-button" onclick="closeModal('loginModal')">×</span>
        <h2>Вход</h2>
        <form id="loginForm" data-login-url="{% url 'login' %}"> <!-- Убрал атрибут action и добавил id и data-login-url -->
            {% csrf_token %}
            <input type="text" placeholder="Логин или email" name="username" required>
            <input type="password" placeholder="Пароль" name="password" required>
            <button type="submit" class="btn btn-primary">Войти</button>
            <div id="loginError" class="alert alert-danger d-none"></div> <!-- Изменил div для сообщений об ошибках -->
        </form>
    </div>
</div>

<!-- Модальное окно для регистрации -->
<div id="signupModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-button" onclick="closeModal('signupModal')">×</span>
        <h2>Регистрация</h2>
        <form method="post" action="{% url 'signup' %}">
            {% csrf_token %}
            <input type="text" placeholder="Логин" name="username" required>
            <input type="email" placeholder="Email" name="email" required>
            <input type="password" placeholder="Пароль" name="password" id="password" required pattern=".{8,}" title="Пароль должен содержать не менее 8 символов">
            <input type="password" placeholder="Подтвердите пароль" name="confirm_password" id="confirm_password" required oninput="check(this)">
            <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
            <div id="loginErrorMessage"></div>
        </form>
        <div id="loginError" style="color: red;"></div>
    </div>
</div>

{% include 'main/footer.html' %}

{% block script %}

{% endblock %}

<script>
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        var blurBackground = document.createElement('div');
        blurBackground.classList.add('blur-background');
        document.body.appendChild(blurBackground);
        
        modal.style.display = "block";
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        var blurBackground = document.querySelector('.blur-background');
        if (blurBackground) blurBackground.remove();
        
        modal.style.display = "none";
    }
    
    // Обработка клика вне модального окна
    window.onclick = function(event) {
        if (event.target.classList.contains('custom-modal')) {
            event.target.style.display = "none";
        }
    }
    function check(input) {
        if (input.value != document.getElementById('password').value) {
            input.setCustomValidity('Пароли не совпадают.');
        } else {
            // Пароль совпадает, ошибка не требуется
            input.setCustomValidity('');
        }
    }
</script>
<script>
    window.onload = function() {
        if (document.querySelector(".messages .alert")) {
            openModal('loginModal');
        }
    };
    window.onclick = function(event) {
    if (event.target.classList.contains('blur-background')) {
        closeModal('loginModal'); // Закрыть модальное окно

    }
}
</script>
<script>
    // Вспомогательная функция для получения значения CSRF токена
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // Обработка отправки формы входа
    document.addEventListener('DOMContentLoaded', function() {
        var loginForm = document.getElementById('loginForm');
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var errorDiv = document.getElementById('loginError');
            var formData = new FormData(this);

            fetch(loginForm.dataset.loginUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('loginModal'); // Закрыть модальное окно
                    location.reload(); // Перезагрузить страницу, чтобы обновить состояние пользователя
                } else {
                    errorDiv.textContent = data.error; // Показать сообщение об ошибке
                    errorDiv.classList.add('alert-error'); // добавляет красную линию, когда есть ошибка
                    errorDiv.classList.remove('d-none'); // Убедитесь, что элемент видим
                }
            })
            .catch(error => {
                console.error('Ошибка при попытке входа:', error);
            });
        });
    });
</script>


</body>
</html>
